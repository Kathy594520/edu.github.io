<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ‰‡å½¢è¤‡åˆåœ–å½¢è§£é¡Œç­–ç•¥å·¥åŠ</title>
    <style>
        :root {
            --bg-color: #F0F4F8; 
            --primary-color: #1976D2; 
            --accent-color: #FF9800; 
            --text-color: #333;
            --card-bg: #FFFFFF;
            --success-color: #4CAF50;
            --error-color: #F44336;
            --selected-border: #2196F3;
            
            /* å„å½¢ç‹€ä¸»é¡Œè‰² */
            --track-pink: #F8BBD0;
            --ear-blue: #B3E5FC;
            --moon-purple: #D1C4E9;
            --olive-green: #DCEDC8;
            --ring-orange: #FFE0B2;
            --corner-gray: #CFD8DC;
        }

        body {
            font-family: 'å¾®è»Ÿæ­£é»‘é«”', 'Microsoft JhengHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            color: var(--text-color);
        }

        /* é ‚éƒ¨å°èˆª */
        header {
            background: white;
            padding: 10px 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            z-index: 20;
            flex-shrink: 0;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary-color);
            font-weight: 700;
        }

        /* åˆ†é æ¨™ç±¤ */
        .tabs-container {
            background: white;
            padding: 8px 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .tabs {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            padding: 0 15px;
            gap: 10px;
            scrollbar-width: none; /* Firefox */
        }
        
        .tabs::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        .tab-btn {
            padding: 8px 18px;
            border: 2px solid transparent;
            background: #EEEEEE;
            border-radius: 20px;
            font-size: 0.95rem;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .tab-btn.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 4px 6px rgba(25, 118, 210, 0.3);
        }

        /* ä¸»è¦å…§å®¹å€ */
        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            position: relative;
        }

        /* ä¸ŠåŠéƒ¨ï¼šåœ–å½¢æ¼”ç¤ºå€ - ä½”ç”¨æœ€å¤§ç©ºé–“ */
        #stage-area {
            flex-grow: 1; 
            flex-shrink: 0; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            background-color: #E3F2FD; 
            padding: 10px;
            border-bottom: 1px solid #ddd;
            min-height: 45vh; 
            max-height: 55vh; 
        }

        /* åœ–ç‰‡èˆ‡SVGå®¹å™¨ - æœ€å¤§åŒ–é¡¯ç¤º */
        .visual-container {
            width: 95%; 
            height: 95%; 
            max-width: 600px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 4px solid white; 
            margin-bottom: 5px;
        }

        /* é¡Œç›®åŸåœ– */
        .question-img {
            max-width: 95%;
            max-height: 95%;
            object-fit: contain;
            transition: opacity 0.3s;
        }

        /* å‹•ç•« SVG */
        .animation-svg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s; background: white; z-index: 5;
            display: flex; align-items: center; justify-content: center;
        }
        .animation-svg svg { width: 100%; height: 100%; max-height: 100%; }
        .animation-svg.active { opacity: 1; pointer-events: auto; }

        /* æ§åˆ¶å€ */
        .controls {
            position: absolute;
            top: 15px; right: 15px;
            z-index: 25;
        }

        .hint-text {
            position: absolute;
            bottom: 5px; 
            font-size: 1.2rem;
            font-weight: bold;
            color: #D81B60; 
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px);
            z-index: 25;
            pointer-events: none;
            max-width: 90%;
        }

        .hint-text.show { opacity: 1; transform: translateY(0); }

        .action-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.95rem;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
            display: flex; align-items: center; gap: 6px;
            font-weight: bold;
            transition: transform 0.1s;
        }
        .action-btn:active { transform: scale(0.95); }

        /* ä¸‹åŠéƒ¨ï¼šç®—å¼å¡ç‰‡å€ */
        #cards-section {
            flex: 1; 
            display: flex;
            flex-direction: column;
            background-color: #EEEEEE;
            position: relative;
            overflow: hidden; 
        }

        .instruction-box {
            text-align: center;
            color: #555;
            font-size: 1rem;
            padding: 10px 0;
            background: #E0E0E0;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            flex-shrink: 0;
        }

        #cards-container {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            align-content: start; 
            padding-bottom: 90px; 
        }

        /* å¡ç‰‡æ¨£å¼å„ªåŒ– */
        .math-card {
            background: white;
            border: 3px solid transparent;
            border-radius: 16px;
            padding: 15px 12px; 
            font-size: 1rem; 
            cursor: pointer; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
            transition: all 0.15s ease-out;
            text-align: center;
            display: flex; align-items: center; justify-content: center;
            min-height: 70px; 
            word-break: break-word;
            font-weight: 600;
            color: #333;
            line-height: 1.4;
        }

        /* å¡ç‰‡é¡å‹é‚Šæ¡†è‰² */
        .math-card[data-hint="fraction"] { border-left: 6px solid #FFCC80; }
        .math-card[data-hint="decimal"] { border-left: 6px solid #80CBC4; }
        .math-card[data-hint="concept"] { border-left: 6px solid #CE93D8; }

        .math-card.selected {
            border-color: var(--selected-border);
            background-color: #E3F2FD;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(33, 150, 243, 0.25);
        }

        .math-card.correct { border-color: var(--success-color); background-color: #E8F5E9; color: #2E7D32; font-weight: bold; pointer-events: none; }
        .math-card.wrong { border-color: var(--error-color); background-color: #FFEBEE; color: #C62828; }
        .math-card.missed { border: 3px dashed var(--success-color); opacity: 0.7; }

        /* æŒ‰éˆ•ç¾¤çµ„å€å¡Š - å›ºå®šåœ¨åº•éƒ¨ */
        .btn-group-container {
            padding: 15px;
            background: #EEEEEE;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-shrink: 0; 
            z-index: 30;
        }

        .submit-btn, .cancel-btn {
            flex: 1;
            border: none;
            padding: 12px 0;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            max-width: 200px;
        }

        #submit-btn {
            background-color: var(--primary-color);
            color: white;
            flex: 1.5;
        }
        
        #cancel-btn {
            background-color: #B0BEC5;
            color: white;
            flex: 1;
        }

        #submit-btn:active, #cancel-btn:active { transform: scale(0.95); }
        #submit-btn:disabled { background-color: #CFD8DC; cursor: not-allowed; box-shadow: none; color: #90A4AE;}
        #cancel-btn:hover { background-color: #90A4AE; }

        /* åº•éƒ¨ç‰ˆæ¬Š */
        footer {
            background: #37474F;
            color: #CFD8DC;
            text-align: center;
            padding: 5px;
            font-size: 0.8rem;
            flex-shrink: 0;
        }

        /* å½ˆå‡ºå›é¥‹ */
        #feedback-overlay {
            position: absolute;
            top: 45%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px 40px;
            border-radius: 50px;
            font-size: 1.3rem;
            font-weight: bold;
            display: none;
            z-index: 1000;
            pointer-events: none;
            white-space: nowrap;
            box-shadow: 0 10px 30px rgba(0,0,0,0.4);
        }
        
        .reset-btn {
            position: absolute;
            top: 10px; left: 10px;
            background: rgba(255,255,255,0.9);
            border: none;
            border-radius: 50%;
            width: 40px; height: 40px;
            cursor: pointer;
            font-size: 1.4rem;
            display: flex; align-items: center; justify-content: center;
            color: #333; z-index: 50;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }
        .reset-btn:active { transform: rotate(-180deg); }

    </style>
</head>
<body>

<header>
    <h1>æ‰‡å½¢è¤‡åˆåœ–å½¢è§£é¡Œç­–ç•¥å·¥åŠ</h1>
</header>
<div id="score-timer-bar" style="display:flex; justify-content:space-between; padding:8px 16px; background:#fff; border-bottom:1px solid #ddd; font-size:1rem; font-weight:bold; color:#333;">
    <div>â± æ™‚é–“ï¼š<span id="timer">0</span> ç§’</div>
    <div>â­ åˆ†æ•¸ï¼š<span id="score">0</span> åˆ†</div>
</div>


<div class="tabs-container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('track')">è·‘é“å½¢</button>
        <button class="tab-btn" onclick="switchTab('ears')">è²“è€³å½¢</button>
        <button class="tab-btn" onclick="switchTab('moon')">æ“²æ¯å½¢</button>
        <button class="tab-btn" onclick="switchTab('olive')">æ©„æ¬–çƒå½¢</button>
        <button class="tab-btn" onclick="switchTab('ring')">ç”œç”œåœˆå½¢</button>
        <button class="tab-btn" onclick="switchTab('corner')">å½è§’å½¢</button>
    </div>
</div>

<div id="main-content">
    <!-- ä¸ŠåŠéƒ¨ï¼šæ¼”ç¤ºå€ -->
    <div id="stage-area">
        <div class="visual-container">
            <!-- é¡¯ç¤ºåŸåœ– -->
            <div id="main-image-container" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center;">
                 <img id="main-image" class="question-img" src="" alt="é¡Œç›®åœ–å½¢" style="display:none">
                 <svg id="placeholder-svg" viewBox="0 0 100 100" style="width:50%; opacity:0.3; display:none;">
                     <circle cx="50" cy="50" r="40" fill="#ddd" />
                     <text x="50" y="55" text-anchor="middle" font-size="12" fill="#666">åœ–å½¢è¼‰å…¥ä¸­</text>
                 </svg>
            </div>
            
            <!-- å‹•ç•«å±¤ SVG -->
            <div id="svg-layer" class="animation-svg"></div>

            <button class="reset-btn" onclick="resetView()" title="é‡ç½®">â†º</button>
            
            <div class="controls">
                <button class="action-btn" onclick="playAnimation()">
                    <span>ğŸ’¡</span> çœ‹è§£é¡Œç­–ç•¥å‹•ç•«
                </button>
            </div>

            <div id="hint-display" class="hint-text"></div>
        </div>
        <div id="feedback-overlay"></div>
    </div>

    <!-- ä¸‹åŠéƒ¨ï¼šå¡ç‰‡èˆ‡æŒ‰éˆ•å€ -->
    <div id="cards-section">
        <div class="instruction-box">ğŸ‘‡ è¤‡é¸é¡Œï¼šè«‹é¸å‡ºæ‰€æœ‰æ­£ç¢ºçš„ç®—å¼</div>
        
        <div id="cards-container">
            <!-- å¡ç‰‡å°‡ç”± JS äº‚æ•¸ç”Ÿæˆ -->
        </div>
        
        <!-- ç¨ç«‹çš„æŒ‰éˆ•å®¹å™¨ -->
        <div class="btn-group-container">
            <button id="cancel-btn" class="cancel-btn" onclick="cancelSelection()">å–æ¶ˆé‡é¸</button>
            <button id="submit-btn" class="submit-btn" onclick="submitAnswer()">é€å‡ºç­”æ¡ˆ</button>
        </div>
    </div>
</div>

<footer>ä»™å§‘å‡±è¥¿è¨­è¨ˆ</footer>

<script>
let timerInterval=null; let elapsedTime=0; let score=0;

    // åœ–ç‰‡è³‡æºé€£çµ
    const imgData = {
        track: "uploaded:20251129150353.jpg-55110a24-6fcc-406d-bb09-f9e10aaad0de",
        ears: "uploaded:20251129150835.jpg-7bb9ced0-50bc-4c4c-a31e-9b5354ab1acb", 
        moon: "uploaded:20251129151659.jpg-1726a61b-e0b5-48dc-82d2-71007c1bed1f", 
        olive: "uploaded:20251129150508.png-7bfdcd19-442d-4018-9916-a01a2103000a", 
        ring: "uploaded:20251129150743.png-bd935825-c448-4af7-a0d5-7b9904da640b", 
        corner: "uploaded:20251129151724.jpg-83506721-e2f6-434e-a6a2-94e867c9e69b"
    };

    // é—œå¡è¨­å®š
    const levels = {
        'track': {
            name: 'è·‘é“å½¢',
            imgSrc: imgData.track, 
            hint: 'å¤§åœ“é¢ç© - å°åœ“é¢ç© + ç›´è·‘é“ x 2',
            acceptedAnswers: ['A1', 'A2', 'A3'], 
            color: '#F4C2C2'
        },
        'ears': {
            name: 'è²“è€³å½¢',
            imgSrc: imgData.ears,
            hint: 'å››åˆ†ä¹‹ä¸€åœ“ - å¤§ç­‰è…°ç›´è§’ä¸‰è§’å½¢',
            acceptedAnswers: ['B1', 'B2', 'B3', 'B4', 'B5', 'B6'], 
            color: '#ADD8E6'
        },
        'moon': {
            name: 'æ“²æ¯å½¢',
            imgSrc: imgData.moon,
            hint: 'å››åˆ†ä¹‹ä¸€åœ“ - ç­‰è…°ç›´è§’ä¸‰è§’å½¢',
            acceptedAnswers: ['C1', 'C2', 'C3'], 
            color: '#9370DB'
        },
        'olive': {
            name: 'æ©„æ¬–çƒå½¢',
            imgSrc: imgData.olive,
            hint: '(å…©å€‹å››åˆ†ä¹‹ä¸€åœ“) - æ­£æ–¹å½¢',
            acceptedAnswers: ['E1', 'E2', 'E3', 'E4'],
            color: '#C5E1A5'
        },
        'ring': {
            name: 'ç”œç”œåœˆå½¢',
            imgSrc: imgData.ring,
            hint: 'å¤§æ‰‡å½¢ - å°æ‰‡å½¢',
            acceptedAnswers: ['F1', 'F2', 'F3'],
            color: '#FFCC80'
        },
        'corner': {
            name: 'å½è§’å½¢',
            imgSrc: imgData.corner,
            hint: 'æ­£æ–¹å½¢ - å››åˆ†ä¹‹ä¸€åœ“',
            acceptedAnswers: ['G1', 'G2', 'G3'],
            color: '#B0BEC5'
        }
    };

    // å¡ç‰‡æ± 
    const formulas = [
        // A: è·‘é“å½¢
        { id: 'A1', text: '(å¤§åŠå¾‘Â²Ã—Ï€ - å°åŠå¾‘Â²Ã—Ï€) + (é•·Ã—å¯¬Ã—2)', type: 'track', hintType: 'fraction' },
        { id: 'A2', text: '(å¤§åœ“é¢ç© - å°åœ“é¢ç©) + ç›´è·‘é“ç¸½é¢ç©', type: 'track', hintType: 'concept' },
        { id: 'A3', text: 'åœ“ç’°é¢ç© + å…©æ¢ç›´è·‘é“é¢ç©', type: 'track', hintType: 'concept' },
        { id: 'A_err1', text: 'å¤§åœ“é¢ç© + å°åœ“é¢ç© + é•·æ–¹å½¢é¢ç©', type: 'track', hintType: 'concept' }, 
        { id: 'A_err2', text: 'å¤§åœ“å‘¨é•· Ã— å°åœ“å‘¨é•·', type: 'track', hintType: 'decimal' },

        // B: è²“è€³å½¢
        { id: 'B1', text: '(åŠå¾‘Â²Ã—3.14) Ã· 4 - (åº•Ã—é«˜) Ã· 2', type: 'ears', hintType: 'fraction' },
        { id: 'B2', text: '(åŠå¾‘Â²Ã—3.14) Ã— 90/360 - (åº•Ã—é«˜) Ã· 2', type: 'ears', hintType: 'fraction' },
        { id: 'B3', text: '0.25 Ã— åœ“é¢ç© - ä¸‰è§’å½¢é¢ç©', type: 'ears', hintType: 'decimal' },
        { id: 'B4', text: '(åŠå¾‘Â²Ã—3.14) Ã· 4 - (åº•Ã—é«˜ Ã· 2)', type: 'ears', hintType: 'fraction' },
        { id: 'B5', text: 'å››åˆ†ä¹‹ä¸€åœ“ - ä¸‰è§’å½¢', type: 'ears', hintType: 'concept' }, 
        { id: 'B6', text: 'æ‰‡å½¢é¢ç© - ç­‰è…°ç›´è§’ä¸‰è§’å½¢', type: 'ears', hintType: 'concept' },
        { id: 'B_err1', text: 'åŠå¾‘Â²Ã—3.14 Ã· 2 - åº•Ã—é«˜', type: 'ears', hintType: 'fraction' }, 
        { id: 'B_err2', text: 'æ‰‡å½¢é¢ç© + ä¸‰è§’å½¢é¢ç©', type: 'ears', hintType: 'concept' },

        // C: æ“²æ¯å½¢
        { id: 'C1', text: '0.25 Ã— åœ“é¢ç© - ä¸‰è§’å½¢é¢ç©', type: 'moon', hintType: 'decimal' },
        { id: 'C2', text: '(åŠå¾‘Â²Ã—3.14) Ã· 4 - (åº•Ã—é«˜) Ã· 2', type: 'moon', hintType: 'fraction' },
        { id: 'C3', text: 'æ‰‡å½¢é¢ç© - ç­‰è…°ç›´è§’ä¸‰è§’å½¢', type: 'moon', hintType: 'concept' },
        { id: 'C_err1', text: 'åŠå¾‘Â²Ã—3.14 Ã· 2 - åº•Ã—é«˜ Ã· 2', type: 'moon', hintType: 'fraction' }, 
        { id: 'C_err2', text: 'æ­£æ–¹å½¢é¢ç© - æ‰‡å½¢é¢ç©', type: 'moon', hintType: 'concept' },

        // E: æ©„æ¬–çƒå½¢
        { id: 'E1', text: '(æ‰‡å½¢é¢ç© Ã— 2) - æ­£æ–¹å½¢é¢ç©', type: 'olive', hintType: 'concept' },
        { id: 'E2', text: 'é‚Šé•· Ã— é‚Šé•· Ã— 0.57', type: 'olive', hintType: 'decimal' },
        { id: 'E3', text: '(åŠå¾‘Â²Ã—3.14Ã·4) Ã— 2 - é‚Šé•·Â²', type: 'olive', hintType: 'fraction' },
        { id: 'E4', text: '(0.25 Ã— åœ“é¢ç©) Ã— 2 - æ­£æ–¹å½¢', type: 'olive', hintType: 'decimal' },
        { id: 'E_err1', text: 'æ­£æ–¹å½¢é¢ç© - åœ“é¢ç©', type: 'olive', hintType: 'concept' }, 
        { id: 'E_err2', text: 'æ‰‡å½¢é¢ç© - ä¸‰è§’å½¢é¢ç©', type: 'olive', hintType: 'concept' },

        // F: ç”œç”œåœˆå½¢
        { id: 'F1', text: '(å¤§åŠå¾‘Â² - å°åŠå¾‘Â²) Ã— 3.14 Ã— 1/4', type: 'ring', hintType: 'fraction' },
        { id: 'F2', text: 'å¤§æ‰‡å½¢é¢ç© - å°æ‰‡å½¢é¢ç©', type: 'ring', hintType: 'concept' },
        { id: 'F3', text: '(å¤§åœ“é¢ç© - å°åœ“é¢ç©) Ã· 4', type: 'ring', hintType: 'fraction' },
        { id: 'F_err1', text: '(å¤§åŠå¾‘ - å°åŠå¾‘)Â² Ã— 3.14 Ã— 1/4', type: 'ring', hintType: 'fraction' }, 
        { id: 'F_err2', text: 'å¤§åœ“å‘¨é•· - å°åœ“å‘¨é•·', type: 'ring', hintType: 'concept' },

        // G: å½è§’å½¢
        { id: 'G1', text: 'é‚Šé•·Â² - (åŠå¾‘Â² Ã— 3.14 Ã· 4)', type: 'corner', hintType: 'fraction' },
        { id: 'G2', text: 'æ­£æ–¹å½¢é¢ç© - æ‰‡å½¢é¢ç©', type: 'corner', hintType: 'concept' },
        { id: 'G3', text: 'é‚Šé•·Â² Ã— (1 - 0.785)', type: 'corner', hintType: 'decimal' }, 
        { id: 'G_err1', text: 'æ‰‡å½¢é¢ç© - æ­£æ–¹å½¢é¢ç©', type: 'corner', hintType: 'concept' },
        { id: 'G_err2', text: 'æ­£æ–¹å½¢é¢ç© - ä¸‰è§’å½¢é¢ç©', type: 'corner', hintType: 'concept' }
    ];

    let currentTab = 'track';
    let selectedCards = new Set(); 

    window.onload = function() {
        switchTab('track');
    };

    function switchTab(tabName){ startTimer(); 
        currentTab = tabName;
        const buttons = document.querySelectorAll('.tab-btn');
        buttons.forEach(btn => {
            btn.classList.remove('active');
            const onClickAttr = btn.getAttribute('onclick');
            if (onClickAttr && onClickAttr.indexOf(`'${tabName}'`) !== -1) {
                btn.classList.add('active');
            }
        });
        
        const img = document.getElementById('main-image');
        const placeholder = document.getElementById('placeholder-svg');
        
        // éš±è—/é‡ç½®æ‰€æœ‰
        img.style.display = 'none';
        placeholder.style.display = 'none';

        if(levels[tabName].imgSrc) {
             img.src = levels[tabName].imgSrc;
             img.style.display = 'block';
        } else {
             placeholder.style.display = 'block';
        }
        
        resetView();
        renderCards();
    }

    function resetView(){ startTimer(); 
        document.getElementById('svg-layer').classList.remove('active');
        document.getElementById('svg-layer').innerHTML = ''; 
        document.getElementById('hint-display').classList.remove('show');
        document.getElementById('hint-display').innerText = '';
        document.getElementById('feedback-overlay').style.display = 'none';
        
        cancelSelection(); 
    }
    
    function cancelSelection() {
        selectedCards.clear();
        document.querySelectorAll('.math-card').forEach(card => {
            card.classList.remove('selected', 'correct', 'wrong', 'missed');
            // ç¢ºä¿å¯ä»¥é‡æ–°é»é¸
            card.style.pointerEvents = 'auto'; 
        });
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = false;
        submitBtn.innerText = "é€å‡ºç­”æ¡ˆ";
        submitBtn.style.backgroundColor = "var(--primary-color)";
    }

    function forcePlayVideo() {
        // Since video is removed, this function is now moot, but kept for safety.
        console.log("Video functionality is removed.");
    }

    function playAnimation() {
        const hintDisplay = document.getElementById('hint-display');
        renderSVG(currentTab);
        
        // è§¸ç™¼ SVG å…§éƒ¨çš„ CSS Transition
        let delay = 1500;

        if (currentTab === 'track') {
            setTimeout(() => {
                const left = document.getElementById('anim-left');
                const right = document.getElementById('anim-right');
                const straight = document.getElementById('anim-straight');

                if(left) left.style.transform = 'translateX(60px)';
                if(right) right.style.transform = 'translateX(-60px)';
                if(straight) straight.style.opacity = '0.1';
            }, 500);
        } else if (currentTab === 'ears') {
            // è²“è€³å½¢ï¼šSVG å‹•ç•« (æ¢å¾©ç‰ˆæœ¬)
            const text = document.getElementById('ear-step-text');
            const leftG = document.getElementById('group-left');
            const rightG = document.getElementById('group-right');
            const bigSector = document.getElementById('ear-big-sector');
            const finalTri = document.getElementById('final-white-tri');
            const label = document.getElementById('ear-label');
            const arrowL = document.getElementById('arrow-left');
            const arrowR = document.getElementById('arrow-right');
            
            delay = 7000; // ç¢ºä¿å‹•ç•«è·‘å®Œ

            // 1. åˆ†é›¢
            setTimeout(() => { 
                if(text) text.textContent = "1. åˆ†é›¢ï¼šå°‡å…©å€‹æ‰‡å½¢åˆ†é–‹"; 
                if(leftG) leftG.style.transform = "translateX(-20px) rotate(-15deg)"; 
                if(rightG) rightG.style.transform = "translateX(20px) rotate(15deg)"; 
            }, 800);
            
            // 2. ç¿»è½‰
            setTimeout(() => { 
                if(text) text.textContent = "2. ç¿»è½‰ï¼šæ—‹è½‰å°é½Šï¼Œæº–å‚™æ‹¼æˆå››åˆ†ä¹‹ä¸€åœ“"; 
                if(arrowL) arrowL.style.opacity = '1';
                if(arrowR) arrowR.style.opacity = '1';
                if(leftG) leftG.style.transform = "rotate(45deg)"; 
                if(rightG) rightG.style.transform = "rotate(45deg) translate(-20px, -20px)"; 
            }, 2500);
            
            // éš±è—ç®­é ­
            setTimeout(() => {
                if(arrowL) arrowL.style.opacity = '0';
                if(arrowR) arrowR.style.opacity = '0';
            }, 3800);

            // 3. æ‹¼åˆ
            setTimeout(() => { 
                if(text) text.textContent = "3. æ‹¼åˆï¼šè®Šæˆä¸€å€‹ 90Â° çš„å¤§æ‰‡å½¢ (å››åˆ†ä¹‹ä¸€åœ“)"; 
                if(leftG) leftG.style.opacity = '0';
                if(rightG) rightG.style.opacity = '0';
                if(bigSector) {
                    bigSector.style.opacity = '1';
                    bigSector.style.transform = "scale(1.05)";
                    setTimeout(() => bigSector.style.transform = "scale(1)", 300);
                }
            }, 4500);
            
            // 4. æ‰£é™¤
            setTimeout(() => { 
                if(text) text.textContent = "4. çµè«–ï¼šå¤§æ‰‡å½¢é¢ç© - ä¸‰è§’å½¢é¢ç©"; 
                if(finalTri) finalTri.style.opacity = '0.8'; 
                if(label) label.style.opacity = '1'; 
            }, 6000);

        } else if (currentTab === 'moon') {
            setTimeout(() => { if(document.getElementById('remove-moon-tri')) document.getElementById('remove-moon-tri').style.opacity = '0.9'; if(document.getElementById('moon-label')) document.getElementById('moon-label').style.opacity = '1'; }, 500);
        } else if (currentTab === 'olive') {
            const s1 = document.getElementById('olive-s1');
            const s2 = document.getElementById('olive-s2');
            const leaf = document.getElementById('olive-leaf');
            const label = document.getElementById('olive-label');
            if(s1) { s1.style.opacity = '0'; setTimeout(() => s1.style.opacity = '0.6', 200); }
            if(s2) { s2.style.opacity = '0'; setTimeout(() => s2.style.opacity = '0.6', 800); }
            if(leaf && label) setTimeout(() => { leaf.style.opacity = '0.8'; label.style.opacity = '1'; }, 1500);
        } else if (currentTab === 'ring') {
            setTimeout(() => { if(document.getElementById('ring-remove')) document.getElementById('ring-remove').style.opacity = '0.9'; if(document.getElementById('ring-label')) document.getElementById('ring-label').style.opacity = '1'; }, 500);
        } else if (currentTab === 'corner') {
            setTimeout(() => { if(document.getElementById('corner-remove')) document.getElementById('corner-remove').style.opacity = '0.9'; if(document.getElementById('corner-label')) document.getElementById('corner-label').style.opacity = '1'; }, 500);
        }

        setTimeout(() => {
            hintDisplay.innerText = levels[currentTab].hint;
            hintDisplay.classList.add('show');
        }, delay);
    }

    // ç¹ªè£½ SVG å‹•ç•«
    function renderSVG(type) {
        const container = document.getElementById('svg-layer');
        container.innerHTML = ''; 
        let content = '';
        const w = 380, h = 320;

        if (type === 'track') {
            content = `
                <svg viewBox="0 0 ${w} ${h}">
                    <defs><mask id="track-hole"><rect x="0" y="0" width="${w}" height="${h}" fill="white"/><rect x="130" y="120" width="120" height="80" rx="40" ry="40" fill="black"/></mask></defs>
                    <line x1="190" y1="100" x2="190" y2="220" stroke="#ccc" stroke-dasharray="5,5" />
                    <g id="anim-left" style="transition: transform 1s cubic-bezier(0.25, 1, 0.5, 1);"><path d="M 130 100 A 60 60 0 0 0 130 220 L 130 200 A 40 40 0 0 1 130 120 Z" fill="${levels.track.color}" stroke="#666" stroke-width="2"/></g>
                    <g id="anim-right" style="transition: transform 1s cubic-bezier(0.25, 1, 0.5, 1);"><path d="M 250 100 A 60 60 0 0 1 250 220 L 250 200 A 40 40 0 0 0 250 120 Z" fill="${levels.track.color}" stroke="#666" stroke-width="2"/></g>
                    <g id="anim-straight" style="transition: opacity 0.5s;"><rect x="130" y="100" width="120" height="20" fill="${levels.track.color}" stroke="#666" stroke-width="2"/><rect x="130" y="200" width="120" height="20" fill="${levels.track.color}" stroke="#666" stroke-width="2"/></g>
                    <text x="190" y="70" text-anchor="middle" font-size="14" fill="#666">å°‡å…©å´åŠåœ“å‘å…§æ‹¼æ¥...</text>
                </svg>`;
        } else if (type === 'ears') {
            // è²“è€³å½¢ (SVG ç‰ˆ) - æ¢å¾©ç¬¬ä¸€ç‰ˆè¨­å®š
            content = `
                <svg viewBox="0 0 ${w} ${h}">
                    <defs>
                        <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="#E64A19" />
                        </marker>
                    </defs>
                    <text id="ear-step-text" x="190" y="40" text-anchor="middle" font-size="14" fill="#666">é¡Œç›®åœ–å½¢</text>
                    
                    <g transform="translate(190, 240)">
                        <g id="group-left" style="transition: all 1s ease; transform-origin: 0 0;">
                            <path d="M 0 0 L -85 -85 A 120 120 0 0 1 0 -120 Z" fill="${levels.ears.color}" stroke="#333" stroke-width="2" transform="rotate(-45)"/>
                            <path d="M 0 0 L -85 -85 L 0 -120 Z" fill="white" stroke="#ccc" stroke-dasharray="2,2" transform="rotate(-45)"/>
                        </g>
                        <g id="group-right" style="transition: all 1s ease; transform-origin: 0 0;">
                            <path d="M 0 0 L 85 -85 A 120 120 0 0 0 0 -120 Z" fill="${levels.ears.color}" stroke="#333" stroke-width="2" transform="rotate(45)"/>
                            <path d="M 0 0 L 85 -85 L 0 -120 Z" fill="white" stroke="#ccc" stroke-dasharray="2,2" transform="rotate(45)"/>
                        </g>
                        <path id="arrow-left" d="M -90 -90 Q -110 -60 -80 -40" fill="none" stroke="#E64A19" stroke-width="4" marker-end="url(#arrowhead)" opacity="0" style="transition: opacity 0.3s"/>
                        <path id="arrow-right" d="M 90 -90 Q 110 -60 80 -40" fill="none" stroke="#E64A19" stroke-width="4" marker-end="url(#arrowhead)" opacity="0" style="transition: opacity 0.3s"/>
                        <g id="ear-big-sector" style="opacity: 0; transition: opacity 0.5s;">
                             <path d="M 0 0 L -120 0 A 120 120 0 0 1 0 -120 Z" fill="${levels.ears.color}" stroke="#333" stroke-width="2"/>
                        </g>
                        <path id="final-white-tri" d="M 0 0 L -120 0 L 0 -120 Z" fill="white" stroke="#EA4335" stroke-width="3" opacity="0" style="transition: opacity 0.5s"/>
                        <text x="-40" y="-40" text-anchor="middle" font-size="14" fill="#333" id="ear-label" opacity="0" style="transition: opacity 0.5s">æ‰£é™¤éƒ¨åˆ†</text>
                    </g>
                </svg>`;
        } else if (type === 'moon') {
            content = `
                <svg viewBox="0 0 ${w} ${h}">
                    <text x="190" y="60" text-anchor="middle" font-size="14" fill="#666">è§£é¡Œé—œéµï¼šå››åˆ†ä¹‹ä¸€åœ“ - ä¸‰è§’å½¢</text>
                    <g transform="translate(120, 240) scale(1.3)">
                        <path d="M 0 0 L 120 0 A 120 120 0 0 0 0 -120 Z" fill="${levels.moon.color}" stroke="#333" stroke-width="2"/>
                        <path id="remove-moon-tri" d="M 0 0 L 120 0 L 0 -120 Z" fill="white" stroke="#EA4335" stroke-width="2" stroke-dasharray="3,3" opacity="0" style="transition: opacity 1s;"/>
                        <text x="40" y="-40" text-anchor="middle" font-size="12" fill="#fff" id="moon-label" opacity="0">æ‰£é™¤</text>
                    </g>
                </svg>`;
        } else if (type === 'olive') {
            content = `
                <svg viewBox="0 0 ${w} ${h}">
                    <text x="190" y="40" text-anchor="middle" font-size="14" fill="#666">è§£é¡Œé—œéµï¼šå…©æ‰‡å½¢ç›¸åŠ  - æ­£æ–¹å½¢</text>
                    <g transform="translate(130, 80)">
                        <rect id="olive-sq" x="0" y="0" width="120" height="120" fill="none" stroke="#666" stroke-width="2" stroke-dasharray="5,5"/>
                        <path id="olive-s1" d="M 0 120 L 0 0 A 120 120 0 0 1 120 120 Z" fill="${levels.olive.color}" stroke="#333" stroke-width="2" opacity="0.6" style="transition: opacity 0.5s"/>
                        <path id="olive-s2" d="M 120 0 L 0 0 A 120 120 0 0 0 120 120 Z" fill="${levels.olive.color}" stroke="#333" stroke-width="2" opacity="0.6" style="transition: opacity 0.5s"/>
                        <path id="olive-leaf" d="M 0 0 A 120 120 0 0 0 120 120 A 120 120 0 0 0 0 0 Z" fill="#9CCC65" stroke="#333" stroke-width="2" opacity="0" style="transition: opacity 0.5s"/>
                        <text x="60" y="145" text-anchor="middle" font-size="12" fill="#333" id="olive-label" opacity="0">é‡ç–Šéƒ¨åˆ† = è‘‰å½¢</text>
                    </g>
                </svg>`;
        } else if (type === 'ring') {
            content = `
                <svg viewBox="0 0 ${w} ${h}">
                    <text x="190" y="40" text-anchor="middle" font-size="14" fill="#666">è§£é¡Œé—œéµï¼šå¤§æ‰‡å½¢ - å°æ‰‡å½¢</text>
                    <g transform="translate(190, 200)">
                         <path d="M 0 0 L -100 -100 A 141 141 0 0 1 100 -100 Z" fill="${levels.ring.color}" stroke="#333" stroke-width="2"/>
                         <path id="ring-remove" d="M 0 0 L -50 -50 A 70 70 0 0 1 50 -50 Z" fill="white" stroke="#EA4335" stroke-width="2" stroke-dasharray="3,3" opacity="0" style="transition: opacity 1s;"/>
                         <text x="0" y="-30" text-anchor="middle" font-size="12" fill="#333" id="ring-label" opacity="0">æ‰£é™¤å°æ‰‡å½¢</text>
                    </g>
                </svg>`;
        } else if (type === 'corner') {
            content = `
                <svg viewBox="0 0 ${w} ${h}">
                    <text x="190" y="50" text-anchor="middle" font-size="14" fill="#666">è§£é¡Œé—œéµï¼šæ­£æ–¹å½¢ - æ‰‡å½¢</text>
                    <g transform="translate(130, 100)">
                        <rect x="0" y="0" width="120" height="120" fill="${levels.corner.color}" stroke="#333" stroke-width="2"/>
                        <path id="corner-remove" d="M 0 0 L 120 0 A 120 120 0 0 1 0 120 Z" fill="white" stroke="#EA4335" stroke-width="2" stroke-dasharray="3,3" opacity="0" style="transition: opacity 1s;"/>
                        <text x="40" y="40" text-anchor="middle" font-size="12" fill="#333" id="corner-label" opacity="0">æ‰£é™¤æ‰‡å½¢</text>
                    </g>
                </svg>`;
        }


        container.innerHTML = content;
        container.classList.add('active');
    }

    function renderCards() {
        const container = document.getElementById('cards-container');
        container.innerHTML = '';
        
        let correctPool = formulas.filter(f => levels[currentTab].acceptedAnswers.includes(f.id));
        let errorPool = formulas.filter(f => f.type === currentTab && !levels[currentTab].acceptedAnswers.includes(f.id));
        
        let finalSet = [...correctPool];
        while (finalSet.length < 4 && errorPool.length > 0) {
            let randIndex = Math.floor(Math.random() * errorPool.length);
            finalSet.push(errorPool[randIndex]);
            errorPool.splice(randIndex, 1);
        }
        finalSet.sort(() => Math.random() - 0.5);

        finalSet.forEach(f => {
            const div = document.createElement('div');
            div.className = 'math-card';
            div.innerText = f.text;
            div.dataset.id = f.id;
            if (f.hintType) div.setAttribute('data-hint', f.hintType);
            div.onclick = () => toggleCard(div); 
            container.appendChild(div);
        });
    }

    function toggleCard(card) {
        if (document.getElementById('submit-btn').innerText === "å·²æäº¤") return;

        const id = card.dataset.id;
        if (selectedCards.has(id)) {
            selectedCards.delete(id);
            card.classList.remove('selected');
        } else {
            selectedCards.add(id);
            card.classList.add('selected');
        }
    }

    function submitAnswer() {
        if (document.getElementById('submit-btn').innerText === "å·²æäº¤") {
            resetView();
            renderCards();
            return;
        }

        const correctAnswers = new Set(levels[currentTab].acceptedAnswers);
        const cards = document.querySelectorAll('.math-card');
        let allCorrect = true;
        let anySelected = false;

        cards.forEach(card => {
            const id = card.dataset.id;
            const isSelected = selectedCards.has(id);
            const isActuallyCorrect = correctAnswers.has(id);

            card.classList.remove('correct', 'wrong', 'missed');

            if (isSelected) {
                anySelected = true;
                if (isActuallyCorrect) {
                    card.classList.add('correct');
                } else {
                    card.classList.add('wrong');
                    allCorrect = false;
                }
            } else {
                if (isActuallyCorrect) {
                    card.classList.add('missed');
                    allCorrect = false;
                }
            }
        });

        const feedback = document.getElementById('feedback-overlay');
        
        if (!anySelected) {
            feedback.style.backgroundColor = 'rgba(0,0,0,0.8)';
            feedback.innerText = "è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å€‹ç­”æ¡ˆï¼";
            feedback.style.display = 'block';
            setTimeout(() => feedback.style.display = 'none', 1000);
            return;
        }

        if (allCorrect) {
            feedback.style.backgroundColor = 'rgba(52, 168, 83, 0.95)';
            feedback.innerText = "å¤ªæ£’äº†ï¼å…¨å°ï¼";
            
            const hintDisplay = document.getElementById('hint-display');
            if (!hintDisplay.classList.contains('show')) {
                playAnimation();
             stopTimer(); score+=10; document.getElementById('score').innerText=score; }
            
            document.getElementById('submit-btn').innerText = "å·²æäº¤";
            document.getElementById('submit-btn').style.backgroundColor = "#9E9E9E";
            document.getElementById('submit-btn').disabled = true;
            
        } else {
            feedback.style.backgroundColor = 'rgba(234, 67, 53, 0.95)';
            feedback.innerText = "å†è©¦ä¸€æ¬¡ï¼(è™›ç·šè¡¨ç¤ºæ¼é¸)";
        }
        
        feedback.style.display = 'block';
        setTimeout(() => feedback.style.display = 'none', 2500);
    }

function startTimer(){
 clearInterval(timerInterval);
 elapsedTime=0;
 document.getElementById('timer').innerText=elapsedTime;
 timerInterval=setInterval(()=>{elapsedTime++; document.getElementById('timer').innerText=elapsedTime;},1000);
}
function stopTimer(){clearInterval(timerInterval);}

</script>

</body>
</html>